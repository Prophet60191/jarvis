#!/usr/bin/env python3
"""
Test RAG configurable paths and configuration management.
Verifies that all paths are properly configurable and functional.
"""

import sys
import json
import tempfile
from pathlib import Path

# Add jarvis to path
sys.path.append(str(Path(__file__).parent / "jarvis"))


def test_rag_configuration():
    """Test RAG configuration and path management."""
    print("üîß Testing RAG Configurable Paths")
    print("=" * 50)
    
    try:
        from jarvis.config import get_config, RAGConfig
        from jarvis.tools.rag_config_manager import RAGConfigManager
        
        # Test 1: Load default configuration
        print("üìã Testing Default Configuration...")
        config = get_config()
        rag_config = config.rag
        
        print(f"‚úÖ RAG enabled: {rag_config.enabled}")
        print(f"‚úÖ Vector store path: {rag_config.vector_store_path}")
        print(f"‚úÖ Documents path: {rag_config.documents_path}")
        print(f"‚úÖ Backup path: {rag_config.backup_path}")
        print(f"‚úÖ Chat history path: {rag_config.chat_history_path}")
        print(f"‚úÖ Temp processing path: {rag_config.temp_processing_path}")
        print(f"‚úÖ Logs path: {rag_config.logs_path}")
        
        # Test 2: Configuration Manager
        print("\nüõ†Ô∏è Testing Configuration Manager...")
        config_manager = RAGConfigManager(rag_config)
        
        # Validate configuration
        is_valid, issues = config_manager.validate_configuration()
        if is_valid:
            print("‚úÖ Configuration validation passed")
        else:
            print(f"‚ùå Configuration validation failed:")
            for issue in issues:
                print(f"   - {issue}")
        
        # Test 3: Path validation
        print("\nüìÅ Testing Path Validation...")
        paths_valid, path_issues = config_manager.validate_paths()
        if paths_valid:
            print("‚úÖ All paths are valid and accessible")
        else:
            print(f"‚ùå Path validation failed:")
            for issue in path_issues:
                print(f"   - {issue}")
        
        # Test 4: Directory structure creation
        print("\nüèóÔ∏è Testing Directory Structure Creation...")
        structure_created = config_manager.create_directory_structure()
        if structure_created:
            print("‚úÖ Directory structure created successfully")
        else:
            print("‚ùå Failed to create directory structure")
        
        # Test 5: Path information
        print("\nüìä Testing Path Information...")
        path_info = config_manager.get_path_info()
        
        for path_name, info in path_info.items():
            status = "‚úÖ" if info['exists'] and info['is_writable'] else "‚ö†Ô∏è"
            print(f"{status} {path_name}:")
            print(f"   Path: {info['relative_path']}")
            print(f"   Exists: {info['exists']}")
            print(f"   Writable: {info['is_writable']}")
            print(f"   Items: {info['item_count']}")
            print(f"   Size: {info['size_mb']} MB")
        
        # Test 6: Configuration summary
        print("\nüìà Testing Configuration Summary...")
        summary = config_manager.get_configuration_summary()
        
        print(f"‚úÖ Configuration Summary:")
        print(f"   Enabled: {summary['enabled']}")
        print(f"   Valid: {summary['is_valid']}")
        print(f"   Total paths: {summary['paths']['total_paths']}")
        print(f"   Existing paths: {summary['paths']['existing_paths']}")
        print(f"   Writable paths: {summary['paths']['writable_paths']}")
        print(f"   Total size: {summary['paths']['total_size_mb']} MB")
        print(f"   Chunk size: {summary['settings']['chunk_size']}")
        print(f"   Search K: {summary['settings']['search_k']}")
        print(f"   Intelligent processing: {summary['settings']['intelligent_processing']}")
        
        # Test 7: Configuration export
        print("\nüíæ Testing Configuration Export...")
        try:
            export_path = config_manager.export_configuration()
            print(f"‚úÖ Configuration exported to: {export_path}")
            
            # Verify export file exists and is valid JSON
            if Path(export_path).exists():
                with open(export_path, 'r') as f:
                    exported_config = json.load(f)
                print(f"‚úÖ Export file contains {len(exported_config)} configuration items")
            else:
                print("‚ùå Export file was not created")
                
        except Exception as e:
            print(f"‚ùå Configuration export failed: {e}")
        
        # Test 8: Custom path configuration
        print("\nüéõÔ∏è Testing Custom Path Configuration...")
        try:
            # Create a temporary custom configuration
            with tempfile.TemporaryDirectory() as temp_dir:
                custom_config = RAGConfig(
                    vector_store_path=f"{temp_dir}/custom_vector_store",
                    documents_path=f"{temp_dir}/custom_documents",
                    backup_path=f"{temp_dir}/custom_backups",
                    chat_history_path=f"{temp_dir}/custom_chat_history",
                    temp_processing_path=f"{temp_dir}/custom_temp",
                    logs_path=f"{temp_dir}/custom_logs"
                )
                
                custom_manager = RAGConfigManager(custom_config)
                custom_valid, custom_issues = custom_manager.validate_configuration()
                
                if custom_valid:
                    print("‚úÖ Custom configuration validation passed")
                    
                    # Test directory creation with custom paths
                    custom_structure = custom_manager.create_directory_structure()
                    if custom_structure:
                        print("‚úÖ Custom directory structure created")
                        
                        # Verify directories were created
                        custom_paths = custom_manager.get_path_info()
                        created_count = sum(1 for info in custom_paths.values() if info['exists'])
                        print(f"‚úÖ Created {created_count}/{len(custom_paths)} custom directories")
                    else:
                        print("‚ùå Failed to create custom directory structure")
                else:
                    print(f"‚ùå Custom configuration validation failed: {custom_issues}")
                    
        except Exception as e:
            print(f"‚ùå Custom configuration test failed: {e}")
        
        return True
        
    except ImportError as e:
        print(f"‚ùå Import error: {e}")
        return False
    except Exception as e:
        print(f"‚ùå Configuration test error: {e}")
        return False


def test_rag_service_integration():
    """Test RAG service integration with configurable paths."""
    print("\nüîó Testing RAG Service Integration...")
    
    try:
        from jarvis.config import get_config
        from jarvis.tools.rag_service import RAGService
        
        config = get_config()
        
        # Test RAG service initialization with configured paths
        rag_service = RAGService(config)
        
        print("‚úÖ RAG service initialized with configured paths")
        print(f"   Vector store path: {config.rag.vector_store_path}")
        print(f"   Collection name: {config.rag.collection_name}")
        print(f"   Chunk size: {config.rag.chunk_size}")
        print(f"   Chunk overlap: {config.rag.chunk_overlap}")
        
        # Test document stats (uses configured paths)
        doc_stats = rag_service.get_document_stats()
        print(f"‚úÖ Document stats retrieved: {doc_stats.get('total_documents', 0)} documents")
        
        # Test ingested documents (uses configured paths)
        ingested_docs = rag_service.get_ingested_documents()
        print(f"‚úÖ Ingested documents retrieved: {len(ingested_docs)} documents")
        
        return True
        
    except Exception as e:
        print(f"‚ùå RAG service integration test failed: {e}")
        return False


def main():
    """Main test function."""
    print("üöÄ RAG Configurable Paths Testing Suite")
    print("=" * 60)
    print("Testing comprehensive path configuration and management...")
    print()
    
    tests = [
        ("RAG Configuration", test_rag_configuration),
        ("RAG Service Integration", test_rag_service_integration)
    ]
    
    results = []
    for test_name, test_func in tests:
        try:
            result = test_func()
            results.append((test_name, result))
        except Exception as e:
            print(f"‚ùå {test_name} failed with exception: {e}")
            results.append((test_name, False))
    
    # Summary
    passed = sum(1 for _, result in results if result)
    total = len(results)
    
    print(f"\nüìä RAG Configuration Test Results")
    print("=" * 40)
    for test_name, result in results:
        status = "‚úÖ PASS" if result else "‚ùå FAIL"
        print(f"{status} {test_name}")
    
    print(f"\nüìà Overall Results:")
    print(f"‚úÖ Passed: {passed}/{total}")
    print(f"‚ùå Failed: {total - passed}/{total}")
    print(f"üìä Success Rate: {passed/total*100:.1f}%")
    
    if passed == total:
        print("\nüéâ RAG Configurable Paths: COMPLETE!")
        print("   ‚úÖ All paths properly configurable")
        print("   ‚úÖ Configuration validation working")
        print("   ‚úÖ Directory management functional")
        print("   ‚úÖ RAG service integration successful")
        print("   ‚úÖ Custom configurations supported")
        print("\nüîß RAG system is fully configurable and production-ready!")
    elif passed >= total * 0.8:
        print(f"\n‚úÖ RAG Configurable Paths mostly complete!")
        print(f"   Minor issues detected, but core functionality works")
    else:
        print(f"\n‚ö†Ô∏è  RAG Configurable Paths need attention")
        print(f"   Multiple configuration issues detected")
    
    return passed >= total * 0.8


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
